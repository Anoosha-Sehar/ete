<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Connecting with Taxonomy Databases &#8212; ETE Toolkit 4.0.0-beta documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=039e1c02" />
    <script src="../_static/documentation_options.js?v=f03ed5e5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="connecting-with-taxonomy-databases">
<h1><a class="toc-backref" href="#id7" role="doc-backlink">Connecting with Taxonomy Databases</a><a class="headerlink" href="#connecting-with-taxonomy-databases" title="Link to this heading">¶</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#connecting-with-taxonomy-databases" id="id7">Connecting with Taxonomy Databases</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id8">Overview</a></p></li>
<li><p><a class="reference internal" href="#differences-between-ncbi-and-gtdb-taxonomies-in-ete4" id="id9">Differences between NCBI and GTDB taxonomies in ETE4</a></p></li>
<li><p><a class="reference internal" href="#setting-up-local-copies-of-the-ncbi-and-gtdb-taxonomy-databases" id="id10">Setting up local copies of the NCBI and GTDB taxonomy databases</a></p></li>
<li><p><a class="reference internal" href="#getting-taxid-information" id="id11">Getting taxid information</a></p>
<ul>
<li><p><a class="reference internal" href="#ncbi-taxonomy" id="id12">NCBI taxonomy</a></p></li>
<li><p><a class="reference internal" href="#gtdb-taxonomy" id="id13">GTDB taxonomy</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#getting-descendant-taxa" id="id14">Getting descendant taxa</a></p></li>
<li><p><a class="reference internal" href="#getting-species-tree-topology" id="id15">Getting species tree topology</a></p></li>
<li><p><a class="reference internal" href="#automatic-tree-annotation-using-ncbi-gtdb-taxonomy" id="id16">Automatic tree annotation using NCBI/GTDB taxonomy</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>ETE4 contains <em>ncbi_taxonomy</em> and <em>gtdb_taxonomy</em> modules which provide
utilities to efficiently query a local copy of the NCBI or GTDB taxonomy
databases. The class <code class="docutils literal notranslate"><span class="pre">NCBITaxa</span></code> and <code class="docutils literal notranslate"><span class="pre">GTDBTaxa</span></code> offer methods to convert
from taxid to names (and vice versa), to fetch pruned topologies connecting
a given set of species, or to download rank, names and lineage track information.</p>
<p>It is also fully integrated with PhyloTree instances through the
<code class="docutils literal notranslate"><span class="pre">PhyloNode.annotate_ncbi_taxa()</span></code> and <a href="#id1"><span class="problematic" id="id2">``</span></a>PhyloNode.annotate_gtdb_taxa()``method.</p>
</section>
<section id="differences-between-ncbi-and-gtdb-taxonomies-in-ete4">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Differences between NCBI and GTDB taxonomies in ETE4</a><a class="headerlink" href="#differences-between-ncbi-and-gtdb-taxonomies-in-ete4" title="Link to this heading">¶</a></h2>
<p>The NCBI taxonomy database is a comprehensive resource for organism names and
classifications.It is updated daily and offers multiple access points including a web
portal, an FTP server. The database releases its data in a package called “taxdump.tar.gz” which
contains several .dmp files.</p>
<p>Taxon in NCBI taxonomyis usually a numeric identifier, commonly representing
taxa (“TaxID”), but it can also signify other entities like genetic codes or citations, such as
9606 represents Homo Sapiens.</p>
<p>On the other hand, GTDB taxonomy is distributed as simple text files, uses a genome-based
approach for classification, and the identifiers are usually specific to genomes rather
than taxa.</p>
<p>Since ETE Toolkit version 3, ete3 parses taxdump file to local sqlite database to fullfill the
methods in ncbi_taxonomy module. We applied the same strategy to GTDBTaxa. While the original GTDB
taxonomy data differs from NCBI taxonomy files, a conversion step is essential for integration.</p>
<p>To integrate GTDB into the ETE Toolkit v4, a conversion process was necessary. A third-party script
(<a class="reference external" href="https://github.com/nick-youngblut/gtdb_to_taxdump">https://github.com/nick-youngblut/gtdb_to_taxdump</a>) was employed to convert the GTDB taxonomy to the
NCBI-like taxdump format. We already preprared GTDB taxonomy dump file from different releases version
and store in <a class="reference external" href="https://github.com/etetoolkit/ete-data/tree/main/gtdb_taxonomy">https://github.com/etetoolkit/ete-data/tree/main/gtdb_taxonomy</a>.</p>
</section>
<section id="setting-up-local-copies-of-the-ncbi-and-gtdb-taxonomy-databases">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Setting up local copies of the NCBI and GTDB taxonomy databases</a><a class="headerlink" href="#setting-up-local-copies-of-the-ncbi-and-gtdb-taxonomy-databases" title="Link to this heading">¶</a></h2>
<p>The first time you attempt to use NCBITaxa or GTDBTaxa, ETE will detect that your local
database is empty and it will attempt to download the latest taxonomy database(NCBI ~600MB;GTDB ~72MB) and will
store a parsed version of it in your home directory: ~/.local/share/ete/.
All future imports of NCBITaxa or GTDBTaxa will detect the local database and will
skip this step.</p>
<dl>
<dt>Example::</dt><dd><p># Load NCBI module
from ete4 import NCBITaxa
ncbi = NCBITaxa()
ncbi.update_taxonomy_database()</p>
<p># Load GTDB module
from ete4 import GTDBTaxa
gtdb = GTDBTaxa()
gtdb.update_taxonomy_database()</p>
<p># Load GTDB module with specific release version
from ete4 import GTDBTaxa
gtdb = GTDBTaxa()</p>
<p># latest release updated in <a class="reference external" href="https://github.com/dengzq1234/ete-data/tree/main/gtdb_taxonomy">https://github.com/dengzq1234/ete-data/tree/main/gtdb_taxonomy</a>
gtdb.update_taxonomy_database()
# or
gtdb.update_taxonomy_database(“gtdbdump.tar.gz”)</p>
<p># update with custom release 202
gtdb.update_taxonomy_database(‘gtdb202dump.tar.gz’)</p>
</dd>
</dl>
</section>
<section id="getting-taxid-information">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Getting taxid information</a><a class="headerlink" href="#getting-taxid-information" title="Link to this heading">¶</a></h2>
<section id="ncbi-taxonomy">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">NCBI taxonomy</a><a class="headerlink" href="#ncbi-taxonomy" title="Link to this heading">¶</a></h3>
<p>you can fetch species names, ranks and linage track information for your taxids using the following
methods:</p>
<ul class="simple">
<li><p>NCBITaxa.get_rank()</p></li>
<li><p>NCBITaxa.get_lineage()</p></li>
<li><p>NCBITaxa.get_taxid_translator()</p></li>
<li><p>NCBITaxa.get_name_translator()</p></li>
<li><p>NCBITaxa.translate_to_names()</p></li>
</ul>
<p>The so called get-translator-functions will return a dictionary converting between taxids and species names.
Either species or linage names/taxids are accepted as input.</p>
<dl>
<dt>Example::</dt><dd><p>from ete4 import NCBITaxa
ncbi = NCBITaxa()
taxid2name = ncbi.get_taxid_translator([9606, 9443])
print(taxid2name)
# {9443: ‘Primates’, 9606: ‘Homo sapiens’}</p>
<p>name2taxid = ncbi.get_name_translator([‘Homo sapiens’, ‘primates’])
print(name2taxid)
# {‘Homo sapiens’: [9606], ‘primates’: [9443]}</p>
<p># when the same name points to several taxa, all taxids are returned
name2taxid = ncbi.get_name_translator([‘Bacteria’])
print(name2taxid)
# {‘Bacteria’: [2, 629395]}</p>
</dd>
</dl>
<p>Other functions allow to extract further information using taxid numbers as a query.</p>
<dl>
<dt>Example::</dt><dd><p>from ete4 import NCBITaxa
ncbi = NCBITaxa()</p>
<p>print(ncbi.get_rank([9606, 9443]))
# {9443: u’order’, 9606: u’species’}</p>
<p>print(ncbi.get_lineage(9606))
# [1, 131567, 2759, 33154, 33208, 6072, 33213, 33511, 7711, 89593, 7742,
# 7776, 117570, 117571, 8287, 1338369, 32523, 32524, 40674, 32525, 9347,
# 1437010, 314146, 9443, 376913, 314293, 9526, 314295, 9604, 207598, 9605,
# 9606]</p>
</dd>
</dl>
<p>Combine combine all at once:</p>
<dl>
<dt>Example::</dt><dd><p>from ete4 import NCBITaxa
ncbi = NCBITaxa()</p>
<p>lineage = ncbi.get_lineage(9606)
print(lineage)</p>
<p># [1, 131567, 2759, 33154, 33208, 6072, 33213, 33511, 7711, 89593, 7742,
# 7776, 117570, 117571, 8287, 1338369, 32523, 32524, 40674, 32525, 9347,
# 1437010, 314146, 9443, 376913, 314293, 9526, 314295, 9604, 207598, 9605,
# 9606]</p>
<p>names = ncbi.get_taxid_translator(lineage)
print([names[taxid] for taxid in lineage])</p>
<p># [u’root’, u’cellular organisms’, u’Eukaryota’, u’Opisthokonta’, u’Metazoa’,
# u’Eumetazoa’, u’Bilateria’, u’Deuterostomia’, u’Chordata’, u’Craniata’,
# u’Vertebrata’, u’Gnathostomata’, u’Teleostomi’, u’Euteleostomi’,
# u’Sarcopterygii’, u’Dipnotetrapodomorpha’, u’Tetrapoda’, u’Amniota’,
# u’Mammalia’, u’Theria’, u’Eutheria’, u’Boreoeutheria’, u’Euarchontoglires’,
# u’Primates’, u’Haplorrhini’, u’Simiiformes’, u’Catarrhini’, u’Hominoidea’,
# u’Hominidae’, u’Homininae’, u’Homo’, u’Homo sapiens’]</p>
</dd>
</dl>
</section>
<section id="gtdb-taxonomy">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">GTDB taxonomy</a><a class="headerlink" href="#gtdb-taxonomy" title="Link to this heading">¶</a></h3>
<p>In the NCBI taxonomy database, each species is assigned a unique numeric taxid.
For example, the taxid 9606 refers to Homo sapiens. These taxids serve as
essential keys for tracking lineages within the database.</p>
<p>However, the GTDB database doesn’t originally offer numeric taxids like NCBI
does. In the GTDBTaxa module, we’ve introduced taxids for each species to
facilitate lineage tracking. These taxids, while not officially recognized in
the GTDB database, serve as convenient keys. They help in connecting the lineage
and taxonomic ranks within the local database, making it easier for users to
fetch and relate taxonomic information.</p>
<p>Like NCBITaxa, GTDBTaxa contains similar methods:</p>
<ul class="simple">
<li><p>GTDBTaxa.get_rank()</p></li>
<li><p>GTDBTaxa.get_lineage()</p></li>
<li><p>GTDBTaxa.get_taxid_translator()</p></li>
<li><p>GTDBTaxa.get_name_translator()</p></li>
<li><p>GTDBTaxa.translate_to_names()</p></li>
<li><p>GTDBTaxa.get_name_lineage()</p></li>
</ul>
</section>
</section>
<section id="getting-descendant-taxa">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Getting descendant taxa</a><a class="headerlink" href="#getting-descendant-taxa" title="Link to this heading">¶</a></h2>
<p>Given a taxid or a taxa name from an internal node in the NCBI/GTDB taxonomy tree,
their descendants can be retrieved as follows:</p>
<p>NCBI taxonomy
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example in NCBI taxonomy</span>
<span class="kn">from</span> <span class="nn">ete4</span> <span class="kn">import</span> <span class="n">NCBITaxa</span>
<span class="n">ncbi</span> <span class="o">=</span> <span class="n">NCBITaxa</span><span class="p">()</span>

<span class="n">descendants</span> <span class="o">=</span> <span class="n">ncbi</span><span class="o">.</span><span class="n">get_descendant_taxa</span><span class="p">(</span><span class="s1">&#39;Homo&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ncbi</span><span class="o">.</span><span class="n">translate_to_names</span><span class="p">(</span><span class="n">descendants</span><span class="p">))</span>

<span class="c1"># [u&#39;Homo heidelbergensis&#39;, u&#39;Homo sapiens ssp. Denisova&#39;,</span>
<span class="c1"># u&#39;Homo sapiens neanderthalensis&#39;]</span>

<span class="c1"># you can easily ignore subspecies, so only taxa labeled as &quot;species&quot; will be reported:</span>
<span class="n">descendants</span> <span class="o">=</span> <span class="n">ncbi</span><span class="o">.</span><span class="n">get_descendant_taxa</span><span class="p">(</span><span class="s1">&#39;Homo&#39;</span><span class="p">,</span> <span class="n">collapse_subspecies</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ncbi</span><span class="o">.</span><span class="n">translate_to_names</span><span class="p">(</span><span class="n">descendants</span><span class="p">))</span>

<span class="c1"># [u&#39;Homo sapiens&#39;, u&#39;Homo heidelbergensis&#39;]</span>

<span class="c1"># or even returned as an annotated tree</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ncbi</span><span class="o">.</span><span class="n">get_descendant_taxa</span><span class="p">(</span><span class="s1">&#39;Homo&#39;</span><span class="p">,</span> <span class="n">collapse_subspecies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">,</span><span class="s1">&#39;taxid&#39;</span><span class="p">]))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           ╭╴environmental samples,2665952╶╌╴Homo sapiens environmental sample,2665953</span>
<span class="sd">           │</span>
<span class="sd">           ├╴Homo sapiens,9606</span>
<span class="sd">╴Homo,9605╶┤</span>
<span class="sd">           ├╴Homo heidelbergensis,1425170</span>
<span class="sd">           │</span>
<span class="sd">           ╰╴unclassified Homo,2813598╶╌╴Homo sp.,2813599</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>GTDB taxonomy
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ete4</span> <span class="kn">import</span> <span class="n">GTDBTaxa</span>
<span class="n">gtdb</span> <span class="o">=</span> <span class="n">GTDBTaxa</span><span class="p">()</span>
<span class="n">descendants</span> <span class="o">=</span> <span class="n">gtdb</span><span class="o">.</span><span class="n">get_descendant_taxa</span><span class="p">(</span><span class="s1">&#39;f__Thorarchaeaceae&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">descendants</span><span class="p">)</span>
<span class="c1"># [&#39;GB_GCA_003662765.1&#39;, &#39;GB_GCA_003662805.1&#39;, &#39;GB_GCA_003345555.1&#39;, &#39;GB_GCA_003345595.1&#39;, &#39;GB_GCA_001940705.1&#39;, &#39;GB_GCA_001563335.1&#39;, &#39;GB_GCA_011364905.1&#39;, &#39;GB_GCA_004376265.1&#39;, &#39;GB_GCA_002825515.1&#39;, &#39;GB_GCA_001563325.1&#39;, &#39;GB_GCA_011364985.1&#39;, &#39;GB_GCA_011365025.1&#39;, &#39;GB_GCA_004524565.1&#39;, &#39;GB_GCA_004524595.1&#39;, &#39;GB_GCA_002825465.1&#39;, &#39;GB_GCA_002825535.1&#39;, &#39;GB_GCA_003345545.1&#39;, &#39;GB_GCA_004524445.1&#39;, &#39;GB_GCA_013388835.1&#39;, &#39;GB_GCA_008080745.1&#39;, &#39;GB_GCA_004524435.1&#39;, &#39;GB_GCA_013138615.1&#39;]</span>

<span class="c1">#ignore subspecies, so only taxa labeled as &quot;species&quot; will be reported</span>
<span class="n">descendants</span> <span class="o">=</span> <span class="n">gtdb</span><span class="o">.</span><span class="n">get_descendant_taxa</span><span class="p">(</span><span class="s1">&#39;f__Thorarchaeaceae&#39;</span><span class="p">,</span> <span class="n">collapse_subspecies</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">descendants</span><span class="p">)</span>

<span class="c1">#[&#39;s__MP8T-1 sp002825535&#39;, &#39;s__MP8T-1 sp003345545&#39;, &#39;s__MP8T-1 sp002825465&#39;, &#39;s__MP8T-1 sp004524565&#39;, &#39;s__MP8T-1 sp004524595&#39;, &#39;s__SMTZ1-83 sp011364985&#39;, &#39;s__SMTZ1-83 sp011365025&#39;, &#39;s__SMTZ1-83 sp001563325&#39;, &#39;s__TEKIR-14 sp004524445&#39;, &#39;s__SHMX01 sp008080745&#39;, &#39;s__OWC5 sp003345595&#39;, &#39;s__OWC5 sp003345555&#39;, &#39;s__JACAEL01 sp013388835&#39;, &#39;s__B65-G9 sp003662765&#39;, &#39;s__SMTZ1-45 sp001563335&#39;, &#39;s__SMTZ1-45 sp011364905&#39;, &#39;s__SMTZ1-45 sp001940705&#39;, &#39;s__SMTZ1-45 sp004376265&#39;, &#39;s__SMTZ1-45 sp002825515&#39;, &#39;s__WTCK01 sp013138615&#39;, &#39;s__TEKIR-12S sp004524435&#39;]</span>


<span class="c1">#returned as an annotated tree</span>
<span class="n">descendants</span> <span class="o">=</span> <span class="n">gtdb</span><span class="o">.</span><span class="n">get_descendant_taxa</span><span class="p">(</span><span class="s1">&#39;f__Thorarchaeaceae&#39;</span><span class="p">,</span> <span class="n">collapse_subspecies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">descendants</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">,</span><span class="s1">&#39;rank&#39;</span><span class="p">]))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                            ╭╴s__MP8T-1 sp002825535,species</span>
<span class="sd">                                            │</span>
<span class="sd">                                            ├╴s__MP8T-1 sp003345545,species</span>
<span class="sd">                                            │</span>
<span class="sd">                        ╭╴g__MP8T-1,genus╶┼╴s__MP8T-1 sp002825465,species</span>
<span class="sd">                        │                 │</span>
<span class="sd">                        │                 ├╴s__MP8T-1 sp004524565,species</span>
<span class="sd">                        │                 │</span>
<span class="sd">                        │                 ╰╴s__MP8T-1 sp004524595,species</span>
<span class="sd">                        │</span>
<span class="sd">                        │                   ╭╴s__SMTZ1-83 sp011364985,species</span>
<span class="sd">                        │                   │</span>
<span class="sd">                        ├╴g__SMTZ1-83,genus╶┼╴s__SMTZ1-83 sp011365025,species</span>
<span class="sd">                        │                   │</span>
<span class="sd">                        │                   ╰╴s__SMTZ1-83 sp001563325,species</span>
<span class="sd">                        │</span>
<span class="sd">                        ├╴g__TEKIR-14,genus╶╌╴s__TEKIR-14 sp004524445,species</span>
<span class="sd">                        │</span>
<span class="sd">                        ├╴g__SHMX01,genus╶╌╴s__SHMX01 sp008080745,species</span>
<span class="sd">                        │</span>
<span class="sd">                        │               ╭╴s__OWC5 sp003345595,species</span>
<span class="sd">                        ├╴g__OWC5,genus╶┤</span>
<span class="sd">╴f__Thorarchaeaceae,family╶┤               ╰╴s__OWC5 sp003345555,species</span>
<span class="sd">                        │</span>
<span class="sd">                        ├╴g__JACAEL01,genus╶╌╴s__JACAEL01 sp013388835,species</span>
<span class="sd">                        │</span>
<span class="sd">                        ├╴g__B65-G9,genus╶╌╴s__B65-G9 sp003662765,species</span>
<span class="sd">                        │</span>
<span class="sd">                        │                   ╭╴s__SMTZ1-45 sp001563335,species</span>
<span class="sd">                        │                   │</span>
<span class="sd">                        │                   ├╴s__SMTZ1-45 sp011364905,species</span>
<span class="sd">                        │                   │</span>
<span class="sd">                        ├╴g__SMTZ1-45,genus╶┼╴s__SMTZ1-45 sp001940705,species</span>
<span class="sd">                        │                   │</span>
<span class="sd">                        │                   ├╴s__SMTZ1-45 sp004376265,species</span>
<span class="sd">                        │                   │</span>
<span class="sd">                        │                   ╰╴s__SMTZ1-45 sp002825515,species</span>
<span class="sd">                        │</span>
<span class="sd">                        ├╴g__WTCK01,genus╶╌╴s__WTCK01 sp013138615,species</span>
<span class="sd">                        │</span>
<span class="sd">                        ╰╴g__TEKIR-12S,genus╶╌╴s__TEKIR-12S sp004524435,species</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="getting-species-tree-topology">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Getting species tree topology</a><a class="headerlink" href="#getting-species-tree-topology" title="Link to this heading">¶</a></h2>
<p>Getting the taxonomy tree for a given set of species is one of the most useful ways
to get all information at once. The method NCBITaxa.get_topology() or GTDBTaxa.get_topology() allows to query your
local NCBI/GTDB database and extract the smallest tree that connects all your query taxids.
It returns a normal ETE tree in which all nodes, internal or leaves, are annotated for
lineage, scientific names, ranks, and so on.</p>
<p>NCBI taxonomy
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ete4</span> <span class="kn">import</span> <span class="n">NCBITaxa</span>
<span class="n">ncbi</span> <span class="o">=</span> <span class="n">NCBITaxa</span><span class="p">()</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">ncbi</span><span class="o">.</span><span class="n">get_topology</span><span class="p">([</span><span class="mi">9606</span><span class="p">,</span> <span class="mi">9598</span><span class="p">,</span> <span class="mi">10090</span><span class="p">,</span> <span class="mi">7707</span><span class="p">,</span> <span class="mi">8782</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sci_name&quot;</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">]))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    ╭╴Dendrochirotida,order</span>
<span class="sd">                    │</span>
<span class="sd">                    │                                                                   ╭╴Homo sapiens,species</span>
<span class="sd">╴Deuterostomia,clade╶┤                                             ╭╴Homininae,subfamily╶┤</span>
<span class="sd">                    │               ╭╴Euarchontoglires,superorder╶┤                     ╰╴Pan troglodytes,species</span>
<span class="sd">                    │               │                             │</span>
<span class="sd">                    ╰╴Amniota,clade╶┤                             ╰╴Mus musculus,species</span>
<span class="sd">                                    │</span>
<span class="sd">                                    ╰╴Aves,class</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># all intermediate nodes connecting the species can also be kept in the tree</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ncbi</span><span class="o">.</span><span class="n">get_topology</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">33208</span><span class="p">],</span> <span class="n">intermediate_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sci_name&quot;</span><span class="p">]))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    ╭╴Eukaryota╶╌╴Opisthokonta╶╌╴Metazoa</span>
<span class="sd">╴cellular organisms╶┤</span>
<span class="sd">                    ╰╴Bacteria</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>GTDB taxonomy
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ete4</span> <span class="kn">import</span> <span class="n">GTDBTaxa</span>
<span class="n">gtdb</span> <span class="o">=</span> <span class="n">GTDBTaxa</span><span class="p">()</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">gtdb</span><span class="o">.</span><span class="n">get_topology</span><span class="p">([</span><span class="s2">&quot;p__Huberarchaeota&quot;</span><span class="p">,</span> <span class="s2">&quot;o__Peptococcales&quot;</span><span class="p">,</span> <span class="s2">&quot;f__Korarchaeaceae&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                        ╭╴p__Huberarchaeota,phylum</span>
<span class="sd">            ╭╴d__Archaea,superkingdom╶┤</span>
<span class="sd">╴root,no rank╶┤                         ╰╴f__Korarchaeaceae,family</span>
<span class="sd">            │</span>
<span class="sd">            ╰╴o__Peptococcales,order</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># all intermediate nodes connecting the species can also be kept in the tree</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">gtdb</span><span class="o">.</span><span class="n">get_topology</span><span class="p">([</span><span class="s2">&quot;p__Huberarchaeota&quot;</span><span class="p">,</span> <span class="s2">&quot;o__Peptococcales&quot;</span><span class="p">,</span> <span class="s2">&quot;f__Korarchaeaceae&quot;</span><span class="p">],</span> <span class="n">intermediate_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collapse_subspecies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annotate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                        ╭╴p__Huberarchaeota,phylum</span>
<span class="sd">            ╭╴d__Archaea,superkingdom╶┤</span>
<span class="sd">╴root,no rank╶┤                         ╰╴p__Thermoproteota,phylum╶╌╴c__Korarchaeia,class╶╌╴o__Korarchaeales,order╶╌╴f__Korarchaeaceae,family</span>
<span class="sd">            │</span>
<span class="sd">            ╰╴d__Bacteria,superkingdom╶╌╴p__Firmicutes_B,phylum╶╌╴c__Peptococcia,class╶╌╴o__Peptococcales,order</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="automatic-tree-annotation-using-ncbi-gtdb-taxonomy">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Automatic tree annotation using NCBI/GTDB taxonomy</a><a class="headerlink" href="#automatic-tree-annotation-using-ncbi-gtdb-taxonomy" title="Link to this heading">¶</a></h2>
<p>NCBI/GTDB taxonomy annotation consists of adding additional information to any internal a leaf node
in a give user tree. Only an property containing the taxid associated to each node
is required for the nodes in the query tree. The annotation process will add the
following features to the nodes:</p>
<ul class="simple">
<li><p>sci_name</p></li>
<li><p>taxid</p></li>
<li><p>named_lineage</p></li>
<li><p>lineage</p></li>
<li><p>rank</p></li>
</ul>
<p>Note that, for internal nodes, taxid can be automatically inferred based on their sibling
nodes. The easiest way to annotate a tree is to use a PhyloTree instance where the species
name attribute is transparently used as the taxid attribute. Note that
the <a href="#id3"><span class="problematic" id="id4">:PhyloNode:`annotate_ncbi_taxa`</span></a>: or <a href="#id5"><span class="problematic" id="id6">:PhyloNode:`annotate_gtdb_taxa`</span></a>: function will also return the used name, lineage and
rank translators.</p>
<p>Remember that species names in PhyloTree instances are automatically extracted from leaf names. The parsing method can be easily adapted to any formatting:</p>
<p>NCBI taxonomy
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ete4</span> <span class="kn">import</span> <span class="n">PhyloTree</span>

<span class="c1"># load the whole leaf name as species taxid</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">PhyloTree</span><span class="p">(</span><span class="s1">&#39;((9606, 9598), 10090);&#39;</span><span class="p">,</span> <span class="n">sp_naming_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="p">)</span>
<span class="n">tax2names</span><span class="p">,</span> <span class="n">tax2lineages</span><span class="p">,</span> <span class="n">tax2rank</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">annotate_ncbi_taxa</span><span class="p">()</span>


<span class="c1"># split names by &#39;|&#39; and return the first part as the species taxid</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">PhyloTree</span><span class="p">(</span><span class="s1">&#39;((9606|protA, 9598|protA), 10090|protB);&#39;</span><span class="p">,</span> <span class="n">sp_naming_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">tax2names</span><span class="p">,</span> <span class="n">tax2lineages</span><span class="p">,</span> <span class="n">tax2rank</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">annotate_ncbi_taxa</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;sci_name&quot;</span><span class="p">,</span> <span class="s2">&quot;taxid&quot;</span><span class="p">]))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                                            ╭╴9606|protA,Homo sapiens,9606</span>
<span class="sd">                                 ╭╴(empty),Homininae,207598╶┤</span>
<span class="sd">╴(empty),Euarchontoglires,314146╶┤                          ╰╴9598|protA,Pan troglodytes,9598</span>
<span class="sd">                                 │</span>
<span class="sd">                                 ╰╴10090|protB,Mus musculus,10090</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>GTDB taxonomy
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ete4</span> <span class="kn">import</span> <span class="n">PhyloTree</span>

<span class="c1"># load the whole leaf name as species taxid</span>
<span class="n">newick</span> <span class="o">=</span> <span class="s1">&#39;((p__Huberarchaeota,f__Korarchaeaceae)d__Archaea,o__Peptococcales);&#39;</span>

<span class="n">tree</span><span class="o">=</span> <span class="n">PhyloTree</span><span class="p">(</span><span class="n">newick</span><span class="p">)</span>
<span class="n">tax2name</span><span class="p">,</span> <span class="n">tax2track</span><span class="p">,</span> <span class="n">tax2rank</span> <span class="o">=</span> <span class="n">gtdb</span><span class="o">.</span><span class="n">annotate_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">taxid_attr</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                        ╭╴p__Huberarchaeota,phylum</span>
<span class="sd">              ╭╴d__Archaea,superkingdom╶┤</span>
<span class="sd">╴root,no rank╶┤                         ╰╴f__Korarchaeaceae,family</span>
<span class="sd">              │</span>
<span class="sd">              ╰╴o__Peptococcales,order</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">ETE Toolkit</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions (FAQs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2008 - 2023, The ETE Toolkit Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/tutorial/tutorial_taxonomy.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>